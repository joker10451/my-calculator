# Apache конфигурация для favicon файлов и HTTP заголовков

# Включаем mod_expires для кэширования
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Favicon файлы - долгосрочное кэширование (1 год)
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    
    # Manifest файл - краткосрочное кэширование (1 день)
    ExpiresByType application/json "access plus 1 day"
</IfModule>

# Настройка MIME типов
<IfModule mod_mime.c>
    # Favicon MIME типы
    AddType image/x-icon .ico
    AddType image/vnd.microsoft.icon .ico
    AddType image/svg+xml .svg
    AddType image/png .png
    AddType application/json .json
</IfModule>

# Заголовки Cache-Control
<IfModule mod_headers.c>
    # Favicon файлы
    <FilesMatch "\.(ico)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Content-Type-Options "nosniff"
        Header set Access-Control-Allow-Origin "*"
        Header set Cross-Origin-Resource-Policy "cross-origin"
        Header set Vary "Accept-Encoding"
    </FilesMatch>
    
    # SVG иконки
    <FilesMatch "icon\.svg$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Content-Type-Options "nosniff"
        Header set Access-Control-Allow-Origin "*"
        Header set Cross-Origin-Resource-Policy "cross-origin"
        Header set Vary "Accept-Encoding"
    </FilesMatch>
    
    # PNG иконки
    <FilesMatch "(apple-touch-icon|icon-\d+)\.png$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Content-Type-Options "nosniff"
        Header set Access-Control-Allow-Origin "*"
        Header set Cross-Origin-Resource-Policy "cross-origin"
        Header set Vary "Accept-Encoding"
    </FilesMatch>
    
    # Manifest файл
    <FilesMatch "manifest\.json$">
        Header set Cache-Control "public, max-age=86400"
        Header set X-Content-Type-Options "nosniff"
        Header set Access-Control-Allow-Origin "*"
        Header set Cross-Origin-Resource-Policy "cross-origin"
        Header set Vary "Accept-Encoding"
    </FilesMatch>
    
    # Общие заголовки безопасности
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Сжатие файлов
<IfModule mod_deflate.c>
    # Сжимаем текстовые файлы
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Альтернативная конфигурация сжатия для mod_gzip
<IfModule mod_gzip.c>
    mod_gzip_on Yes
    mod_gzip_dechunk Yes
    mod_gzip_item_include file \.(html?|txt|css|js|php|pl|json|svg)$
    mod_gzip_item_include mime ^application/x-javascript.*
    mod_gzip_item_include mime ^application/json.*
    mod_gzip_item_include mime ^text/.*
    mod_gzip_item_include mime ^image/svg+xml.*
    mod_gzip_item_exclude rspheader ^Content-Encoding:.*gzip.*
</IfModule>

# Правила перезаписи для favicon fallback
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Если запрашивается /favicon.ico и файл не существует, возвращаем 404
    # (не перенаправляем на index.html)
    RewriteCond %{REQUEST_URI} ^/favicon\.ico$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^.*$ - [R=404,L]
    
    # Аналогично для других favicon файлов
    RewriteCond %{REQUEST_URI} ^/(icon\.svg|apple-touch-icon\.png|icon-\d+\.png|manifest\.json)$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^.*$ - [R=404,L]
</IfModule>