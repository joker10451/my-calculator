# Настройка Яндекс Метрики

## Установленный счётчик

ID счётчика: **106217699**

## Что установлено

### 1. Базовый счётчик в index.html

Счётчик установлен в `<head>` секции с следующими параметрами:
- `clickmap: true` - карта кликов
- `trackLinks: true` - отслеживание внешних ссылок
- `accurateTrackBounce: true` - точный показатель отказов
- `webvisor: true` - вебвизор для записи действий пользователей
- `trackHash: true` - отслеживание хеш-навигации (важно для HashRouter)

### 2. React интеграция

Создан хук `useYandexMetrika` в `src/hooks/useYandexMetrika.ts` для отслеживания переходов между страницами в SPA.

**Функции:**
- `useYandexMetrika()` - автоматически отслеживает переходы между страницами
- `trackYandexGoal(goalName, params)` - отслеживание целей
- `trackYandexParams(params)` - отправка параметров визита

### 3. Интеграция в App.tsx

Добавлен компонент `YandexMetrikaTracker` который автоматически отслеживает все переходы в приложении.

## Использование

### Отслеживание целей

```typescript
import { trackYandexGoal } from '@/hooks/useYandexMetrika';

// Пример: отслеживание расчёта ипотеки
trackYandexGoal('mortgage_calculated', {
  amount: 5000000,
  term: 20,
  rate: 12.5
});

// Пример: отслеживание клика по кнопке
trackYandexGoal('button_click', {
  button_name: 'calculate',
  page: 'mortgage'
});
```

### Отслеживание параметров визита

```typescript
import { trackYandexParams } from '@/hooks/useYandexMetrika';

// Пример: отправка информации о пользователе
trackYandexParams({
  user_type: 'registered',
  subscription: 'premium'
});
```

## Рекомендуемые цели для настройки в Яндекс Метрике

1. **Расчёты калькуляторов**
   - `mortgage_calculated` - расчёт ипотеки
   - `credit_calculated` - расчёт кредита
   - `salary_calculated` - расчёт зарплаты
   - `deposit_calculated` - расчёт вклада

2. **Взаимодействие с контентом**
   - `comparison_started` - начало сравнения
   - `comparison_completed` - завершение сравнения
   - `blog_post_read` - прочтение статьи блога

3. **Конверсионные действия**
   - `contact_form_submitted` - отправка формы контактов
   - `calculator_shared` - поделился калькулятором
   - `result_downloaded` - скачал результат

## Проверка работы

1. Откройте сайт в браузере **без блокировщика рекламы**
2. Откройте консоль разработчика (F12)
3. **В режиме разработки** при переходе между страницами должны появляться сообщения:
   ```
   Yandex Metrika: page view tracked https://schitay-online.ru/#/calculator/mortgage
   ```
   
   **Примечание:** В production сборке логи в консоль не выводятся.

4. Проверьте в Яндекс Метрике:
   - Зайдите в счётчик 106217699
   - Перейдите в раздел "Отчёты" → "Стандартные отчёты" → "Посещаемость"
   - Данные должны начать поступать в течение 15-30 минут

5. **Важно:** Если у вас установлен блокировщик рекламы (AdBlock, uBlock Origin и т.п.):
   - Скрипт Яндекс Метрики будет заблокирован
   - В консоли появится ошибка `ERR_BLOCKED_BY_CLIENT`
   - Это нормально - для реальных пользователей без блокировщиков всё работает
   - Для тестирования отключите блокировщик или используйте режим инкогнито

## Важные замечания

- Используется `HashRouter`, поэтому включен параметр `trackHash: true`
- Все переходы отслеживаются автоматически через хук
- Для production сборки console.log можно отключить, убрав их из хука
- Вебвизор записывает действия пользователей - убедитесь, что это соответствует политике конфиденциальности

## Troubleshooting

### Счётчик не работает (ERR_BLOCKED_BY_CLIENT)

**Причина:** Скрипт Яндекс Метрики блокируется блокировщиком рекламы (AdBlock, uBlock Origin и т.п.)

**Решение:**
1. Это нормальное поведение - блокировщики рекламы блокируют счётчики аналитики
2. Для реальных пользователей без блокировщиков счётчик работает корректно
3. Для тестирования:
   - Отключите блокировщик рекламы на вашем сайте
   - Используйте режим инкогнито без расширений
   - Используйте другой браузер без блокировщиков

**Проверка:**
```javascript
// В консоли браузера
console.log(typeof window.ym); // должно быть 'function' если не заблокирован
```

### Двойной хеш в URL (исправлено)

Проблема с URL вида `https://schitay-online.ru/#//#/` была исправлена в хуке `useYandexMetrika`.
Теперь URL формируется корректно для HashRouter.

### Счётчик не работает

1. Проверьте, что скрипт загружается:
   ```javascript
   console.log(typeof window.ym); // должно быть 'function'
   ```

2. Проверьте консоль на ошибки загрузки скрипта

3. Убедитесь, что ID счётчика правильный (106217699)

### Переходы не отслеживаются

1. Проверьте, что `YandexMetrikaTracker` добавлен в App.tsx
2. Проверьте консоль в dev режиме - должны быть сообщения о треке страниц
3. Убедитесь, что `trackHash: true` установлен в конфигурации

### Статистика не появляется в Яндекс Метрике

1. Подождите 15-30 минут после первого визита
2. Проверьте, что вы смотрите правильный счётчик (106217699)
3. Убедитесь, что посещения не блокируются блокировщиками рекламы
4. Проверьте фильтры в отчётах Яндекс Метрики

## Дополнительные возможности

### E-commerce отслеживание

Если планируется добавить монетизацию через реферальные ссылки:

```typescript
// Отслеживание покупки/конверсии
window.ym(106217699, 'reachGoal', 'purchase', {
  order_price: 5000,
  currency: 'RUB'
});
```

### Пользовательские параметры

```typescript
// Отправка информации о расчёте
trackYandexParams({
  calculator_type: 'mortgage',
  calculation_result: 'affordable',
  loan_amount: 5000000
});
```
