# Implementation Plan: PSB Card Integration

## Overview

Интеграция дебетовой карты "Твой Кешбэк" от банка ПСБ в существующую систему калькуляторов. Реализация включает создание конфигурации данных, React компонента для отображения, интеграцию с существующей системой трекинга и тестирование.

## Tasks

- [x] 1. Расширить типы для поддержки дебетовых карт
  - Добавить тип 'debit' в ProductType в src/types/bank.ts
  - Добавить опциональное поле cashback в ProductFeatures
  - _Requirements: 1.1, 4.4_

- [x] 2. Создать конфигурацию данных карты ПСБ
  - [x] 2.1 Создать файл src/config/psbCard.ts с типизированными данными
    - Определить интерфейс PSBCardData
    - Экспортировать константу с данными карты (кешбэк, преимущества, ограничения)
    - Включить партнерскую ссылку и erid
    - Хранить комиссию внутри (не экспортировать в публичный API)
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 2.2 Написать unit тесты для конфигурации
    - Проверить наличие всех обязательных полей
    - Проверить формат партнерской ссылки
    - Проверить наличие erid
    - Проверить что комиссия не экспортируется в публичном API
    - _Requirements: 1.1, 1.3, 1.4, 1.5_

- [x] 3. Добавить карту ПСБ в конфигурацию партнерских ссылок
  - Обновить src/config/affiliateLinks.ts
  - Добавить запись 'psb-debit-cashback' с партнерской ссылкой
  - Указать commission для внутреннего трекинга
  - _Requirements: 4.1, 4.4_


- [x] 4. Создать компонент PSBCardWidget
  - [x] 4.1 Создать файл src/components/PSBCardWidget.tsx
    - Определить интерфейс PSBCardWidgetProps (source, variant, className, showDetails)
    - Реализовать компонент используя Card, CardHeader, CardContent, CardFooter
    - Отобразить название карты, логотип банка, ключевые преимущества
    - Добавить маленький лейбл "Реклама • erid: ..." внизу карточки
    - Использовать ReferralButton для кнопки оформления
    - Реализовать варианты 'compact' и 'full'
    - _Requirements: 2.1, 2.3, 2.4, 2.7_

  - [x] 4.2 Написать unit тесты для PSBCardWidget
    - Проверить рендеринг с разными props
    - Проверить отображение всех ключевых преимуществ
    - Проверить наличие лейбла "Реклама" с erid
    - Проверить что комиссия не отображается
    - Проверить рендеринг кнопки CTA
    - _Requirements: 2.1, 2.3, 2.4, 2.5_

  - [x] 4.3 Написать property тест: Commission data is never rendered
    - **Property 2: Commission data is never rendered**
    - **Validates: Requirements 2.5, 5.6**
    - Генерировать случайные props для PSBCardWidget
    - Рендерить компонент
    - Проверить что HTML не содержит числа 1633, 1774
    - Проверить что HTML не содержит слова "комиссия", "выплата"

- [x] 5. Добавить обработку кликов и трекинг
  - [x] 5.1 Интегрировать useReferralTracking в PSBCardWidget
    - Использовать хук useReferralTracking из существующей системы
    - Вызывать trackClick при клике на кнопку
    - Передавать source из props компонента
    - Открывать партнерскую ссылку в новой вкладке
    - _Requirements: 3.1, 3.2, 3.3, 4.2, 4.3_

  - [x] 5.2 Написать unit тесты для трекинга
    - Проверить что trackClick вызывается при клике
    - Проверить что передаются правильные параметры (productId, bankId, source)
    - Проверить что ссылка открывается в новой вкладке
    - Проверить что erid присутствует в ссылке
    - _Requirements: 3.1, 3.2, 3.3, 3.4_


- [x] 6. Добавить аналитику Yandex Metrica
  - [x] 6.1 Добавить отслеживание просмотров карточки
    - Использовать useEffect для отправки события при монтировании компонента
    - Отправлять событие 'psb_card_view' в Yandex Metrica
    - Включать source в данные события
    - _Requirements: 5.1, 5.5_

  - [x] 6.2 Добавить отслеживание кликов
    - Отправлять событие 'psb_card_click' при клике на кнопку
    - Включать source и productId в данные события
    - _Requirements: 5.2, 5.5_

  - [x] 6.3 Написать unit тесты для аналитики
    - Проверить что событие view отправляется при монтировании
    - Проверить что событие click отправляется при клике
    - Проверить что события содержат правильные параметры
    - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 7. Реализовать адаптивный дизайн и доступность
  - [x] 7.1 Добавить responsive стили
    - Использовать Tailwind breakpoints для mobile/desktop
    - Компактная версия для мобильных устройств
    - Полная версия для десктопа
    - _Requirements: 7.1, 7.2_

  - [x] 7.2 Добавить accessibility атрибуты
    - Добавить ARIA labels для кнопок и ссылок
    - Обеспечить keyboard navigation (tab, enter)
    - Добавить role="region" для карточки
    - Добавить aria-label для рекламного лейбла
    - _Requirements: 7.3, 7.5_

  - [x] 7.3 Написать accessibility тесты
    - Проверить keyboard navigation
    - Проверить наличие ARIA атрибутов
    - Проверить color contrast (автоматизированный тест)
    - _Requirements: 7.3, 7.4, 7.5_


- [x] 8. Checkpoint - Убедиться что все тесты проходят
  - Запустить все unit тесты
  - Запустить property тесты
  - Проверить что нет TypeScript ошибок
  - Убедиться что компонент рендерится корректно
  - Спросить пользователя если возникли вопросы

- [x] 9. Интегрировать PSBCardWidget на страницы сайта
  - [x] 9.1 Создать хелпер для определения где показывать карту
    - Создать функцию shouldShowPSBCard(pageType, context)
    - Показывать только на релевантных страницах (калькуляторы, списки карт)
    - _Requirements: 8.1, 8.2_

  - [x] 9.2 Добавить карту в раздел продуктов/карт
    - Найти существующую страницу со списком банковских продуктов
    - Добавить PSBCardWidget в список
    - Использовать variant='compact' для списков
    - _Requirements: 8.1, 8.2_

  - [x] 9.3 Добавить карту в калькулятор кешбэка (если существует)
    - Найти калькулятор кешбэка или создать секцию рекомендаций
    - Добавить PSBCardWidget с source='calculator'
    - Показывать только когда контекстуально уместно
    - _Requirements: 8.1, 8.2_

  - [x] 9.4 Написать integration тесты для размещения
    - Проверить что карта отображается на правильных страницах
    - Проверить что карта не отображается на нерелевантных страницах
    - Проверить что карта не имеет unfair prominence
    - _Requirements: 8.1, 8.2, 8.3_


- [x] 10. Добавить обработку ошибок
  - [x] 10.1 Добавить валидацию конфигурации
    - Создать функцию validatePSBCardData
    - Проверять наличие обязательных полей при загрузке
    - Выбрасывать ошибку если erid отсутствует (compliance)
    - _Requirements: 1.5, 6.2_

  - [x] 10.2 Добавить error boundaries для компонента
    - Обернуть PSBCardWidget в error boundary
    - Логировать ошибки рендеринга
    - Показывать fallback UI при ошибках
    - _Requirements: 2.1_

  - [x] 10.3 Добавить обработку ошибок трекинга
    - Обернуть trackClick в try-catch
    - Логировать ошибки но не блокировать UI
    - Всё равно открывать ссылку если трекинг упал
    - _Requirements: 3.1, 3.2_

  - [x] 10.4 Написать unit тесты для error handling
    - Проверить поведение при невалидной конфигурации
    - Проверить что ошибки трекинга не блокируют клики
    - Проверить что error boundary ловит ошибки рендеринга
    - _Requirements: 1.5, 3.1_

- [x] 11. Добавить функцию расчета conversion rate
  - [x] 11.1 Создать утилиту calculateConversionRate
    - Создать файл src/lib/analytics/conversionRate.ts
    - Реализовать функцию (clicks / views) * 100
    - Обработать edge cases (zero views, more clicks than views)
    - _Requirements: 5.4_

  - [x] 11.2 Написать property тест: Conversion rate calculation accuracy
    - **Property 3: Conversion rate calculation accuracy**
    - **Validates: Requirements 5.4**
    - Генерировать случайные массивы событий views и clicks
    - Вызывать calculateConversionRate
    - Проверить что результат = (clicks / views) * 100
    - Проверить edge case: zero views возвращает 0
    - Проверить edge case: clicks > views возвращает максимум 100


- [x] 12. Final checkpoint - Убедиться что всё работает
  - Запустить все тесты (unit + property)
  - Проверить что компонент отображается корректно на всех страницах
  - Проверить responsive поведение на mobile и desktop
  - Проверить что трекинг работает (проверить в консоли Yandex Metrica)
  - Проверить что комиссия нигде не отображается
  - Проверить что erid лейбл присутствует
  - Проверить keyboard navigation и accessibility
  - Спросить пользователя если возникли вопросы

## Notes

- Все задачи являются обязательными для полного покрытия тестами
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и edge cases
- Используется TypeScript для type safety
- Используется Vitest + React Testing Library для unit тестов
- Используется fast-check для property-based тестов
